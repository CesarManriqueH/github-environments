name: Continuous deployment

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: write

jobs:
  set-env:
    runs-on: ubuntu-20.04
    outputs:
      aws_role_to_assume: ${{ steps.set-env.outputs.aws_role_to_assume }}
      env_name: ${{ steps.set-env.outputs.env_name }}
      region: ${{ steps.set-env.outputs.region }}
      base_domain: ${{ steps.set-env.outputs.base_domain }}
      name_prefix: ${{ steps.set-env.outputs.name_prefix }}
    steps:
      - name: Set job level environment
        id: set-env
        run: |
          echo "::set-output name=aws_role_to_assume::arn:aws:iam::168846058973:role/gh-workflow-role"
          echo "::set-output name=env_name::dev"
          echo "::set-output name=region::us-east-1"
          echo "::set-output name=base_domain::cesarmanriqueh.com"
          echo "::set-output name=name_prefix::gh-envs"

  deploy-base-infra:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Deploy terraform
        uses: ./.github/actions/terraform-deployer
        with:
          aws_role_to_assume: ${{ needs.set-env.outputs.aws_role_to_assume }}
          tf_state_region: ${{ needs.set-env.outputs.region }}
          tf_state_bucket: gh-envs-tf-state
          tf_state_dynamodb_table: gh-envs-tf-lock
          tf_workspace: base-dev
          tf_target_dir: infra/base
          tf_vars: |
            env_name = "${{ needs.set-env.outputs.env_name }}"
            region = "${{ needs.set-env.outputs.region }}"
            base_domain = "${{ needs.set-env.outputs.base_domain }}"
    needs: [set-env]

  deploy-main-infra:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Deploy terraform
        uses: ./.github/actions/terraform-deployer
        with:
          aws_role_to_assume: ${{ needs.set-env.outputs.aws_role_to_assume }}
          tf_state_region: ${{ needs.set-env.outputs.region }}
          tf_state_bucket: gh-envs-tf-state
          tf_state_dynamodb_table: gh-envs-tf-lock
          tf_workspace: main-dev
          tf_target_dir: infra/main
          tf_vars: |
            env_name = "${{ needs.set-env.outputs.env_name }}"
            region = "${{ needs.set-env.outputs.region }}"
            name_prefix = "${{ needs.set-env.outputs.name_prefix }}"
            base_domain = "${{ needs.set-env.outputs.base_domain }}"
    needs: [set-env,deploy-base-infra]

  publish-web-app:
    runs-on: ubuntu-20.04
    env:
      BUCKET_NAME: '${{ needs.set-env.outputs.name_prefix }}-${{ needs.set-env.outputs.env_name }}-web-app'
      DOMAIN: 'web-app.${{ needs.set-env.outputs.env_name }}.${{ needs.set-env.outputs.base_domain }}'
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build app
        uses: ./.github/actions/build-nextjs-app
        with:
          path: web-app

      - name: Push artifact to github
        uses: actions/upload-artifact@v2
        with:
          name: web-app
          path: web-app/out

      - name: Configure aws credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          role-to-assume: ${{ needs.set-env.outputs.aws_role_to_assume }}
          aws-region: ${{ needs.set-env.outputs.region }}

      - name: Lookup CF Dist ID
        env:
          ORIGIN_DOMAIN_NAME: "${{ env.BUCKET_NAME }}.s3.amazonaws.com"
        run: |
          CF_DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[].{Id: Id, OriginDomainName: Origins.Items[0].DomainName}[?contains(OriginDomainName, '${ORIGIN_DOMAIN_NAME}')] | [0].Id" \
            --output text)
          echo "ðŸ’¡ Cloudfront Distribution found with ID: ${CF_DIST_ID}"
          echo "CF_DIST_ID=${CF_DIST_ID}" >> $GITHUB_ENV

      - name: Push artifacts to s3
        working-directory: web-app
        run: |
          aws s3 sync out s3://${BUCKET_NAME}/assets --delete --cache-control "max-age=900"
          aws cloudfront create-invalidation --distribution-id ${CF_DIST_ID} --paths "/*"
    needs: [set-env,deploy-main-infra]

  smoke-test:
    runs-on: ubuntu-20.04
    env:
      DOMAIN: 'web-app.${{ needs.set-env.outputs.env_name }}.${{ needs.set-env.outputs.base_domain }}'
    steps:
      - name: Confirm web page loads
        run: |
          url=https://${DOMAIN}
          response=$(curl --write-out '%{http_code}' --silent --output /dev/null $url)
          if [[ $response != "200" ]]; then
            echo "Expected 200 from $url but got $response"
            exit 1
          fi
    needs: [set-env,publish-web-app]
